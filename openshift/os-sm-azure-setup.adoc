---
sidebar: sidebar 
permalink: openshift/os-sm-azure-setup.html 
keywords: NetApp Solutions, redhat OpenShift, red hat OpenShift, redhat openshift container platform, ocp, openshift container platform, Advanced Cluster Management, ACM, Hub Cluster, containers, container workloads, VMware, customer managed storage, ONTAP, Azure, Azure Cloud. 
summary:  
---
= 在 Azure 上部署和配置 Red Hat OpenShift 容器平台
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
本节介绍了如何在 Azure 中设置和管理 OpenShift 群集以及在其上部署有状态应用程序的高级工作流程。它展示了如何使用NetApp Cloud Volumes ONTAP存储在Trident的帮助下提供持久卷。提供了有关使用Trident Protect 为有状态应用程序执行数据保护和迁移活动的详细信息。

下图显示了在 Azure 上部署并使用 VPN 连接到数据中心的集群。

image:rhhc-self-managed-azure.png["该图显示输入/输出对话框或表示书面内容"]


NOTE: 有几种方法可以在 Azure 中部署 Red Hat OpenShift Container 平台集群。此设置的高级描述提供了所使用的特定方法的文档链接。您可以参考link:os-solutions-resources.html["资源部分"]。

设置过程可分为以下步骤：

.从 CLI 在 Azure 上安装 OCP 群集。
[%collapsible%open]
====
* 确保您已满足所有规定的先决条件link:https://docs.openshift.com/container-platform/4.13/installing/installing_azure/installing-azure-vnet.html["此处"]。
* 创建 VPN、子网和网络安全组以及私有 DNS 区域。创建 VPN 网关和站点到站点 VPN 连接。
* 为了实现本地和 Azure 之间的 VPN 连接，我们创建并配置了一个 pfSense VM。有关说明，请参阅link:https://docs.netgate.com/pfsense/en/latest/recipes/ipsec-s2s-psk.html["此处"]。
* 获取安装程序和pull secret，按照文档提供的步骤部署集群link:https://docs.openshift.com/container-platform/4.13/installing/installing_azure/installing-azure-vnet.html["此处"]。
* 集群安装完成，会提供一个kubeconfig文件以及登录集群控制台的用户名和密码。


下面给出了一个示例 install-config.yaml 文件。

....
apiVersion: v1
baseDomain: sddc.netapp.com
compute:
- architecture: amd64
  hyperthreading: Enabled
  name: worker
  platform:
    azure:
      encryptionAtHost: false
      osDisk:
        diskSizeGB: 512
        diskType: "StandardSSD_LRS"
      type: Standard_D2s_v3
      ultraSSDCapability: Disabled
      #zones:
      #- "1"
      #- "2"
      #- "3"
  replicas: 3
controlPlane:
  architecture: amd64
  hyperthreading: Enabled
  name: master
  platform:
    azure:
      encryptionAtHost: false
      osDisk:
        diskSizeGB: 1024
        diskType: Premium_LRS
      type: Standard_D8s_v3
      ultraSSDCapability: Disabled
  replicas: 3
metadata:
  creationTimestamp: null
  name: azure-cluster
networking:
  clusterNetwork:
  - cidr: 10.128.0.0/14
    hostPrefix: 23
  machineNetwork:
  - cidr: 10.0.0.0/16
  networkType: OVNKubernetes
  serviceNetwork:
  - 172.30.0.0/16
platform:
  azure:
    baseDomainResourceGroupName: ocp-base-domain-rg
    cloudName: AzurePublicCloud
    computeSubnet: ocp-subnet2
    controlPlaneSubnet: ocp-subnet1
    defaultMachinePlatform:
      osDisk:
        diskSizeGB: 1024
        diskType: "StandardSSD_LRS"
      ultraSSDCapability: Disabled
    networkResourceGroupName: ocp-nc-us-rg
    #outboundType: UserDefinedRouting
    region: northcentralus
    resourceGroupName: ocp-cluster-ncusrg
    virtualNetwork: ocp_vnet_ncus
publish: Internal
pullSecret:
....
====
.使用BlueXP在 Azure 中部署Cloud Volumes ONTAP 。
[%collapsible%open]
====
* 在 Azure 中安装连接器。参考说明 https://docs.netapp.com/us-en/bluexp-setup-admin/task-install-connector-azure-bluexp.html["此处"]。
* 使用连接器在 Azure 中部署 CVO 实例。请参阅说明链接： https://docs.netapp.com/us-en/bluexp-cloud-volumes-ontap/task-getting-started-azure.html [此处。]


====
.使用Trident的 CSI 拓扑功能实现多区域架构
如今，云提供商使 Kubernetes/OpenShift 集群管理员能够生成基于区域的集群节点。节点可以位于一个区域内的不同可用区，也可以跨多个区域。为了方便在多区域架构中为工作负载配置卷， Trident使用了 CSI 拓扑。使用 CSI 拓扑功能，可以根据区域和可用区域将对卷的访问限制到节点子集。参考link:https://docs.netapp.com/us-en/trident/trident-use/csi-topology.html["此处"]了解更多详细信息。


NOTE: Kubernetes 支持两种卷绑定模式： - 当 **_VolumeBindingMode_ 设置为 _Immediate_**（默认）时， Trident会在没有任何拓扑感知的情况下创建卷。持久卷的创建不依赖于请求 pod 的调度要求。 - 当 **_VolumeBindingMode_ 设置为 _WaitForFirstConsumer_** 时，PVC 的持久卷的创建和绑定将被延迟，直到使用该 PVC 的 pod 被调度和创建。这样，就可以创建卷来满足拓扑要求所强制执行的调度约束。 Trident存储后端可以设计为根据可用区域（拓扑感知后端）选择性地配置卷。对于使用此类后端的 StorageClasses，只有在受支持的区域/区域中调度的应用程序请求时才会创建卷。  （拓扑感知 StorageClass）参考link:https://docs.netapp.com/us-en/trident/trident-use/csi-topology.html["此处"]了解更多详细信息。
