---
sidebar: sidebar 
permalink: vmware/vmw-gcp-gcve-app-dr-ds-veeam.html 
keywords: gcp, gcve, snapcenter, cvo, gcnv, iscsi, guest connect, dr, disaster recovery 
summary: 云端灾难恢复是一种具有弹性且经济高效的方法，可以保护工作负载免受站点中断和勒索软件等数据损坏事件的影响。借助NetApp SnapMirror，使用来宾连接存储的本地 VMware 工作负载可以复制到在 Google Cloud 中运行的NetApp Cloud Volumes ONTAP 。 
---
= 使用NetApp SnapCenter和 Veeam Replication 实现应用程序一致性灾难恢复
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
云端灾难恢复是一种具有弹性且经济高效的方法，可以保护工作负载免受站点中断和勒索软件等数据损坏事件的影响。借助NetApp SnapMirror，使用来宾连接存储的本地 VMware 工作负载可以复制到在 Google Cloud 中运行的NetApp Cloud Volumes ONTAP 。



== 概述

许多客户正在为托管在 VMware vSphere 上的应用程序虚拟机寻找有效的灾难恢复解决方案。他们中的许多人使用现有的备份解决方案在灾难期间进行恢复。很多时候，该解决方案会增加 RTO 并且无法满足他们的期望。为了减少 RPO 和 RTO，只要有网络连接和具有适当权限的环境，就可以利用 Veeam VM 复制，甚至可以从本地到 GCVE。注意：Veeam VM Replication 不保护 VM 客户机连接的存储设备，如客户机 VM 内的 iSCSI 或 NFS 挂载。需要单独保护它们。

为了实现 SQL VM 的应用程序一致性复制并减少 RTO，我们使用SnapCenter来协调 SQL 数据库和日志卷的 SnapMirror 操作。

本文档提供了使用NetApp SnapMirror、Veeam 和 Google Cloud VMware Engine (GCVE) 设置和执行灾难恢复的分步方法。

image:dr-cvs-gcve-veeam-001.png["应用程序虚拟机复制架构"]



== 假设

本文档重点介绍应用程序数据的客户机内存储（也称为客户机连接），我们假设本地环境使用SnapCenter进行应用程序一致性备份。


NOTE: 本文档适用于任何第三方备份或恢复解决方案。根据环境中使用的解决方案，遵循最佳实践来创建符合组织 SLA 的备份策略。

对于本地环境和 Google Cloud 网络之间的连接，请使用专用互连或 Cloud VPN 等连接选项。应根据内部部署 VLAN 设计来创建段。


NOTE: 将本地数据中心连接到 Google Cloud 有多种选择，因此我们无法在本文档中概述特定的工作流程。请参阅 Google Cloud 文档，了解适当的本地到 Google 连接方法。



== 部署灾难恢复解决方案



=== 解决方案部署概述

. 确保使用SnapCenter备份应用程序数据并满足必要的 RPO 要求。
. 在适当的订阅和虚拟网络中，使用BlueXP为Cloud Volumes ONTAP配置正确的实例大小。
+
.. 为相关应用程序卷配置SnapMirror 。
.. 更新SnapCenter中的备份策略以在计划的作业之后触发SnapMirror更新。


. 安装 Veeam 软件并开始将虚拟机复制到 Google Cloud VMware Engine 实例。
. 在灾难事件期间，使用BlueXP中断SnapMirror关系并使用 Veeam 触发虚拟机故障转移。
+
.. 重新连接应用程序虚拟机的 ISCSI LUN 和 NFS 挂载。
.. 在网上启动应用程序。


. 主站点恢复后，通过反向重新同步SnapMirror调用故障回复到受保护站点。




=== 部署详情

.在 Google Cloud 上配置 CVO 并将卷复制到 CVO
[%collapsible%open]
====
第一步是在 Google Cloud 上配置Cloud Volumes ONTAP （link:vmw-gcp-gcve-guest-storage.html["克沃"^] ) 并以所需的频率和快照保留将所需的卷复制到Cloud Volumes ONTAP 。

image:dr-cvo-gcve-002.png["该图显示输入/输出对话框或表示书面内容"]

有关设置SnapCenter和复制数据的示例分步说明，请参阅link:vmw-aws-vmc-guest-storage-dr.html#config-snapmirror["使用SnapCenter设置复制"]

.使用SnapCenter审查 SQL VM 保护
video::395e33db-0d63-4e48-8898-b01200f006ca[panopto]
====
.配置 GCVE 主机和 CVO 数据访问
[%collapsible%open]
====
部署 SDDC 时需要考虑的两个重要因素是 GCVE 解决方案中 SDDC 集群的大小以及保持 SDDC 服务的时间。灾难恢复解决方案的这两个关键考虑因素有助于降低总体运营成本。  SDDC 最小可以只有三台主机，最大可以达到全面部署的多主机集群。

Google Cloud NetApp Volumes for NFS 数据存储区和Cloud Volumes ONTAP for SQL 数据库和日志可以部署到任何 VPC，并且 GCVE 应该具有与该 VPC 的私有连接以挂载 NFS 数据存储区并让 VM 连接到 iSCSI LUN。

要配置 GCVE SDDC，请参阅link:vmw-gcp-gcve-setup.html["在 Google Cloud Platform (GCP) 上部署和配置虚拟化环境"^]。作为先决条件，请验证在建立连接后，驻留在 GCVE 主机上的客户虚拟机是否能够使用来自Cloud Volumes ONTAP的数据。

正确配置Cloud Volumes ONTAP和 GCVE 后，开始配置 Veeam，使用 Veeam 复制功能自动将本地工作负载恢复到 GCVE（具有应用程序 VMDK 的虚拟机和具有来宾内存储的虚拟机），并利用SnapMirror将应用程序卷复制到Cloud Volumes ONTAP。

====
.安装 Veeam 组件
[%collapsible%open]
====
根据部署场景，需要部署Veeam备份服务器、备份存储库和备份代理。对于这种用例，不需要为 Veeam 部署对象存储，也不需要 Scale-out 存储库。https://helpcenter.veeam.com/docs/backup/vsphere/replication_components.html?ver=120["有关安装过程，请参阅 Veeam 文档"]欲了解更多信息，请参阅link:vmw-gcp-gcve-migrate-veeam.html["使用 Veeam Replication 进行迁移"]

====
.使用 Veeam 设置虚拟机复制
[%collapsible%open]
====
本地 vCenter 和 GCVE vCenter 都需要在 Veeam 中注册。 https://helpcenter.veeam.com/docs/backup/vsphere/replica_job.html?ver=120["设置 vSphere VM 复制作业"]在向导的客户机处理步骤中，选择禁用应用程序处理，因为我们将利用SnapCenter进行应用程序感知备份和恢复。

video::8b7e4a9b-7de1-4d48-a8e2-b01200f00692[panopto,width=360]
====
.Microsoft SQL Server VM 的故障转移
[%collapsible%open]
====
video::9762dc99-081b-41a2-ac68-b01200f00ac0[panopto,width=360]
====


== 此解决方案的优势

* 使用SnapMirror的高效且有弹性的复制。
* 通过ONTAP快照保留恢复到任何可用的时间点。
* 从存储、计算、网络和应用程序验证步骤，恢复数百到数千台虚拟机所需的所有步骤均可实现完全自动化。
* SnapCenter使用不会改变复制卷的克隆机制。
+
** 这避免了卷和快照数据损坏的风险。
** 避免 DR 测试工作流程期间的复制中断。
** 利用 DR 数据进行 DR 以外的工作流程，例如开发/测试、安全测试、补丁和升级测试以及补救测试。


* Veeam Replication 允许在 DR 站点上更改 VM IP 地址。

