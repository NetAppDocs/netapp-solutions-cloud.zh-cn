---
sidebar: sidebar 
permalink: vmware/vmw-gcp-gcnv-gcve-ds-dr-veeam.html 
keywords: disaster recovery, avs, google cloud, gcp, gcve, gcnv, google cloud netapp volumes, netapp volumes, dr, veeam, replication 
summary:  
---
= 使用 Veeam Replication 和Google Cloud NetApp Volumes数据存储区实现 Google Cloud VMware Engine 的灾难恢复
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
在危机时刻，全面的灾难恢复计划对于企业来说至关重要。许多组织利用云计算进行日常运营和灾难恢复。这种主动的方法可以减少或消除昂贵的业务中断。

本文介绍如何使用 Veeam Backup & Replication 设置本地 VMware VM 到带有Google Cloud NetApp Volumes (NetApp Volumes) 的 Google Cloud VMware Engine (GCVE) 的灾难恢复。



== 概述

Google Cloud NetApp Volumes是 Google 和NetApp推出的一项存储服务，可用于 Google Cloud。  NetApp Volumes 服务提供高性能 NFS/SMB 存储。 VMware 认证的NetApp Volumes NFS 存储可用作 GCVE 中 ESXi 主机的外部数据存储。用户需要在其 GCVE 私有云和NetApp Volumes 项目之间建立对等连接。区域内的存储访问不产生任何网络费用。用户可以在 Google Cloud 控制台中创建NetApp Volumes 卷，并在将卷作为数据存储区挂载到其 ESXi 主机之前启用删除保护。

基于NetApp Volumes 的 NFS 数据存储区可用于使用任何经过验证且提供 VM 复制功能的第三方解决方案从本地复制数据。通过添加NetApp Volumes 数据存储，可以实现成本优化部署，而无需构建基于 Google Cloud VMware Engine (GCVE) 的 SDDC 并使用大量 ESXi 主机来容纳存储。这种方法被称为“Pilot Light Cluster”。试点灯集群是最小 GCVE 主机配置（3 x GCVE ESXi 主机）以及NetApp Volumes 数据存储容量，以允许独立扩展以满足容量要求。

目标是仅使用管理故障转移的核心组件来维持具有成本效益的基础设施。在发生故障转移时，指示灯集群可以扩展并添加更多 GCVE 主机。一旦故障转移得到解决并且恢复正常运行，指示灯集群就可以缩小规模，返回到低成本的运行模式。



== 本文件的目的

本文介绍如何使用Google Cloud NetApp Volumes数据存储和 Veeam Backup & Replication 来设置本地 VMware VM 到 GCVE 的灾难恢复（使用 Veeam VM 复制软件功能）。

Veeam Backup & Replication 是一款用于虚拟环境的备份和复制应用程序。当虚拟机被复制时，Veeam Backup & Replication 将在目标 GCVE SDDC 集群上以原生 VMware vSphere 格式创建虚拟机的精确副本。 Veeam Backup & Replication 将使副本与原始 VM 保持同步。复制提供了最佳的恢复时间目标 (RTO)，因为 DR 站点上有一个处于准备启动状态的 VM 的安装副本。

这种复制机制确保在发生灾难事件时工作负载能够在 GCVE 中快速启动。 Veeam Backup & Replication 软件还优化了通过 WAN 和慢速连接进行复制的流量传输。此外，它还过滤掉重复的数据块、零数据块、交换文件和“排除的 VM 客户操作系统文件”。该软件还将压缩副本流量。为了防止复制作业消耗整个网络带宽，可以利用 WAN 加速器和网络限制规则。

Veeam Backup & Replication 中的复制过程由作业驱动，这意味着复制是通过配置复制作业来执行的。如果发生灾难事件，可以触发故障转移，通过故障转移到其副本来恢复虚拟机。当执行故障转移时，复制的虚拟机将接管原始虚拟机的角色。可以执行故障转移至副本的最新状态或任何已知的良好还原点。这使得勒索软件恢复或隔离测试能够根据需要进行。  Veeam Backup & Replication 提供多种选项来处理不同的灾难恢复场景。



== 解决方案概述

该解决方案涵盖以下高级步骤：

. 使用Google Cloud NetApp Volumes创建 NFS 卷
. 按照 GCP 流程从NetApp Volumes NFS 卷创建 GCVE 数据存储。
. 设置复制作业以使用 Veeam Backup & Replication 创建 VM 副本。
. 创建故障转移计划并执行故障转移。
. 灾难事件结束且主站点启动后，切换回生产虚拟机。



NOTE: 在NetApp Volumes 中创建卷作为 GCVE 数据存储时，仅支持 NFS v3。

有关使用NetApp Volumes NFS 卷作为 GCVE 数据存储的更多信息，请查看 https://cloud.google.com/vmware-engine/docs/vmware-ecosystem/howto-cloud-volumes-datastores-gcve["使用 NFS 卷作为由Google Cloud NetApp Volumes托管的 vSphere 数据存储"]。



== 架构

下图显示了本文档中提出的解决方案的架构。建议的最佳实践是在本地站点和 GCVE SDDC 中都安装一个 Veeam Backup & Replication 服务器。备份和恢复由内部部署的 Veeam 服务器执行和管理，复制由 GCVE SDDC 中的 Veeam 服务器管理。当主数据中心发生故障时，此架构可提供最高的可用性。

image::dr-veeam-gcnv-001.png[架构图]



== Veeam 复制到 GCVE 和NetApp Volumes 数据存储区的先决条件

此解决方案需要以下组件和配置：

. NetApp Volumes 有一个可用的存储池，具有足够的可用容量来容纳要创建的 NFS 卷。
. Veeam Backup and Replication 软件在具有适当网络连接的本地环境中运行。
. 确保 Veeam Backup & Replication 备份 VM 连接到源以及目标 GCVE SDDC 集群。
. 确保 Veeam Backup & Replication 备份 VM 连接到源和目标 GCVE 集群上的 Veeam 代理服务器 VM。
. 备份服务器必须能够解析短名称并连接到源 vCenter 和目标 vCenter。


用户需要使用 VMware Engine Cloud 控制台 UI 中的 VPC 网络对等或私有连接页面在其 GCVE 私有云和NetApp Volumes 项目之间建立对等连接。


NOTE: 将 GCVE vCenter 服务器添加到 Veeam Backup and Replication 清单时，Veeam 需要具有提升权限的 GCVE 解决方案用户帐户。有关更多信息，请参阅 Google Cloud Platform (GCP) 文档， https://cloud.google.com/vmware-engine/docs/private-clouds/classic-console/howto-elevate-privilege["提升 VMware Engine 权限"] 。

有关更多信息，请参阅 https://helpcenter.veeam.com/docs/backup/vsphere/replica_limitations.html?ver=120["注意事项和限制"]在 Veeam Backup & Replication 文档中。



== 部署步骤

以下部分概述了使用Google Cloud NetApp Volumes创建和挂载 NFS 数据存储的部署步骤，以及使用 Veeam Backup and Replication 在本地数据中心和 Google Cloud VMware Engine 之间实施完整灾难恢复解决方案的步骤。



=== 为 GCVE 创建NetApp Volumes NFS 卷和数据存储

参考 https://cloud.google.com/vmware-engine/docs/vmware-ecosystem/howto-cloud-volumes-datastores-gcve["使用 NFS 卷作为由Google Cloud NetApp Volumes托管的 vSphere 数据存储"]了解如何将Google Cloud NetApp Volumes作为 GCVE 的数据存储的概述。

完成以下步骤以使用NetApp Volumes 为 GCVE 创建和使用 NFS 数据存储：

.创建NetApp Volumes NFS 卷
[%collapsible%open]
====
可从 Google Cloud Platform (GCP) 控制台访问Google Cloud NetApp Volumes 。

参考 https://cloud.google.com/netapp/volumes/docs/configure-and-use/volumes/create-volume["创建卷"]有关此步骤的详细信息，请参阅Google Cloud NetApp Volumes文档。

. 在 Web 浏览器中，导航至 https://console.cloud.google.com/[]并登录您的 GCP 控制台。搜索 * NetApp Volumes* 开始。
. 在* NetApp Volumes* 管理界面中，单击* Create* 开始创建 NFS 卷。
+
image::dr-veeam-gcnv-002.png[创建卷]

+
{nbsp}

. 在“创建卷”向导中，填写所有必需的信息：
+
** 卷的名称。
** 创建卷的存储池。
** 挂载 NFS 卷时使用的共享名称。
** 卷的容量（以 GiB 为单位）。
** 要使用的存储协议。
** 选中该框以*客户端连接时阻止删除卷*（GCVE 作为数据存储安装时需要）。
** 访问卷的导出规则。这是 NFS 网络上 ESXi 适配器的 IP 地址。
** 用于使用本地快照保护卷的快照计划。
** 或者，选择备份卷和/或为卷创建标签。
+

NOTE: 在NetApp Volumes 中创建卷作为 GCVE 数据存储时，仅支持 NFS v3。

+
image::dr-veeam-gcnv-003.png[创建卷]

+
{nbsp}

+
image::dr-veeam-gcnv-004.png[创建卷]

+
{nbsp} 单击“*创建*”以完成卷的创建。



. 一旦创建了卷，就可以从卷的属性页面查看挂载卷所需的 NFS 导出路径。
+
image::dr-veeam-gcnv-005.png[体积属性]



====
.在 GCVE 中挂载 NFS 数据存储
[%collapsible%open]
====
在撰写本文时，在 GCVE 中挂载数据存储的过程需要打开 GCP 支持票证才能将卷挂载为 NFS 数据存储。

参考 https://cloud.google.com/vmware-engine/docs/vmware-ecosystem/howto-cloud-volumes-datastores-gcve["使用 NFS 卷作为由Google Cloud NetApp Volumes托管的 vSphere 数据存储"]了解更多信息。

====


=== 将虚拟机复制到 GCVE 并执行故障转移计划和故障回复

.将虚拟机复制到 GCVE 中的 NFS 数据存储
[%collapsible%open]
====
Veeam Backup & Replication 在复制期间利用 VMware vSphere 快照功能，Veeam Backup & Replication 请求 VMware vSphere 创建 VM 快照。  VM 快照是 VM 的时间点副本，其中包括虚拟磁盘、系统状态、配置和元数据。  Veeam Backup & Replication 使用快照作为复制的数据源。

要复制虚拟机，请完成以下步骤：

. 打开 Veeam 备份和复制控制台。
. 在“主页”选项卡上，单击“复制作业”>“虚拟机...”
+
image::dr-veeam-gcnv-006.png[创建虚拟机复制作业]

+
{nbsp}

. 在“新建复制作业”向导的“名称”页面上，指定作业名称并选择适当的高级控制复选框。
+
** 如果本地和 GCP 之间的连接带宽受限，请选中“副本播种”复选框。
** 如果 GCVE SDDC 上的段与本地站点网络的段不匹配，请选中网络重新映射（针对具有不同网络的 GCVE SDDC 站点）复选框。
** 如果本地生产站点中的 IP 寻址方案与目标 GCVE 站点中的方案不同，请选中副本重新 IP（适用于具有不同 IP 寻址方案的 DR 站点）复选框。
+
image::dr-veeam-gcnv-007.png[姓名页]

+
{nbsp}



. 在“虚拟机”页面上，选择要复制到连接到 GCVE SDDC 的NetApp卷数据存储区的虚拟机。单击*添加*，然后在*添加对象*窗口中选择必要的虚拟机或虚拟机容器，然后单击*添加*。单击“下一步”。
+

NOTE: 可以将虚拟机放置在 vSAN 上以填充可用的 vSAN 数据存储容量。在试点集群中，3 节点 vSAN 集群的可用容量将受到限制。其余数据可以轻松放置在Google Cloud NetApp Volumes数据存储中，以便可以恢复虚拟机，并且可以稍后扩展集群以满足 CPU/内存要求。

+
image::dr-veeam-gcnv-008.png[选择要复制的虚拟机]

+
{nbsp}

. 在*目标*页面上，选择目标作为 GCVE SDDC 集群/主机，并为 VM 副本选择适当的资源池、VM 文件夹和NetApp Volumes 数据存储。单击“*下一步*”继续。
+
image::dr-veeam-gcnv-009.png[选择目的地详情]

+
{nbsp}

. 在“网络”页面上，根据需要创建源虚拟网络和目标虚拟网络之间的映射。单击“*下一步*”继续。
+
image::dr-veeam-gcnv-010.png[网络映射]

+
{nbsp}

. 在*Re-IP*页面上，单击*Add...*按钮添加新的re-ip规则。填写源和目标虚拟机 IP 范围以指定在故障转移时将应用于源虚拟机的网络。使用星号来指定该八位字节的地址范围。单击“*下一步*”继续。
+
image::dr-veeam-gcnv-011.png[重新 IP 页面]

+
{nbsp}

. 在“*作业设置*”页面上，指定将存储 VM 副本元数据的备份存储库、保留策略，然后选择底部的“*高级...*”按钮以进行其他作业设置。单击“*下一步*”继续。
. 在*数据传输*上，选择位于源站点和目标站点的代理服务器，并保持选择直接选项。如果配置了 WAN 加速器，也可以在这里选择。单击“*下一步*”继续。
+
image::dr-veeam-gcnv-012.png[数据传输]

+
{nbsp}

. 在*Guest Processing*页面上，根据需要选中*Enable application-aware processing*复选框，并选择*Guest OS credentials*。单击“*下一步*”继续。
+
image::dr-veeam-gcnv-013.png[客人处理]

+
{nbsp}

. 在“*计划*”页面上，定义复制作业运行的时间和频率。单击“*下一步*”继续。
+
image::dr-veeam-gcnv-014.png[日程安排页面]

+
{nbsp}

. 最后，在*摘要*页面上检查作业设置。勾选“*单击完成时运行该作业*”复选框，然后单击“*完成*”即可完成创建复制作业。
. 一旦运行，就可以在作业状态窗口中查看复制作业。
+
image::dr-veeam-gcnv-015.png[作业状态窗口]

+
有关 Veeam 复制的更多信息，请参阅link:https://helpcenter.veeam.com/docs/backup/vsphere/replication_process.html?ver=120["复制的工作原理"]



====
.创建故障转移计划
[%collapsible%open]
====
初始复制或播种完成后，创建故障转移计划。故障转移计划有助于自动对从属虚拟机逐个或按组执行故障转移。故障转移计划是虚拟机处理顺序（包括启动延迟）的蓝图。故障转移计划还有助于确保关键依赖的虚拟机已经在运行。

完成初始复制或播种后，创建故障转移计划。该计划可作为协调依赖虚拟机（单独或作为一个组）故障转移的战略蓝图。它定义了虚拟机的处理顺序，包含了必要的启动延迟，并确保关键的依赖虚拟机在其他虚拟机之前运行。通过实施结构良好的故障转移计划，组织可以简化其灾难恢复流程，最大限度地减少停机时间并在故障转移事件期间维护相互依赖系统的完整性。

创建计划时，Veeam Backup & Replication 会自动识别并使用最新的还原点来启动 VM 副本。


NOTE: 仅当初始复制完成并且 VM 副本处于就绪状态时，才能创建故障转移计划。


NOTE: 运行故障转移计划时可同时启动的最大虚拟机数量为 10 个。


NOTE: 在故障转移过程中，源虚拟机不会关闭。

要创建*故障转移计划*，请完成以下步骤：

. 在*主页*视图上，单击*恢复*部分中的*故障转移计划*按钮。在下拉菜单中，选择 *VMware vSphere...*
+
image::dr-veeam-gcnv-016.png[创建故障转移计划]

+
{nbsp}

. 在“新建故障转移计划”向导的“常规”页面上，提供计划的名称和说明。可以根据需要添加故障转移前和故障转移后脚本。例如，在启动复制的虚拟机之前运行脚本来关闭虚拟机。
+
image::dr-veeam-gcnv-017.png[常规页面]

+
{nbsp}

. 在“虚拟机”页面上，单击“添加虚拟机”按钮并选择“从副本...”。选择作为故障转移计划一部分的虚拟机，然后修改虚拟机启动顺序和任何所需的启动延迟以满足应用程序依赖关系。
+
image::dr-veeam-gcnv-018.png[虚拟机页面]

+
{nbsp}

+
image::dr-veeam-gcnv-019.png[启动顺序和延迟]

+
{nbsp}

+
单击“*应用*”继续。

. 最后检查所有故障转移计划设置，然后单击“完成”以创建故障转移计划。


有关创建复制作业的其他信息，请参阅link:https://helpcenter.veeam.com/docs/backup/vsphere/replica_job.html?ver=120["创建复制作业"]。

====
.运行故障转移计划
[%collapsible%open]
====
在故障转移期间，生产站点中的源虚拟机将切换到灾难恢复站点上的副本。作为该过程的一部分，Veeam Backup & Replication 将 VM 副本恢复到所需的恢复点，并将所有 I/O 活动从源 VM 传输到其副本。复制品不仅可用于实际灾难，还可用于模拟灾难恢复演习。在故障转移模拟中，源虚拟机继续运行。完成必要的测试后，可以撤消故障转移，恢复正常操作。


NOTE: 确保网络分段到位，以避免故障转移期间发生 IP 冲突。

完成以下步骤以启动故障转移计划：

. 首先，在*主页*视图中，单击左侧菜单中的*副本 > 故障转移计划*，然后单击*开始*按钮。或者，可以使用“*开始到...*”按钮将故障转移到先前的还原点。
+
image::dr-veeam-gcnv-020.png[启动故障转移计划]

+
{nbsp}

. 在*执行故障转移计划*窗口中监控故障转移的进度。
+
image::dr-veeam-gcnv-021.png[监视故障转移进度]

+
{nbsp}




NOTE: Veeam Backup & Replication 停止源 VM 的所有复制活动，直到其副本返回到就绪状态。

有关故障转移计划的详细信息，请参阅link:https://helpcenter.veeam.com/docs/backup/vsphere/failover_plan.html?ver=120["故障转移计划"]。

====
.故障恢复到生产站点
[%collapsible%open]
====
进行故障转移被视为中间步骤，需要根据要求最终确定。选项包括以下内容：

* *故障恢复到生产* - 恢复到原始虚拟机并将副本活动期间所做的所有修改同步回源虚拟机。



NOTE: 在故障恢复期间，更改会被传输但不会立即应用。验证原始虚拟机的功能后，选择“提交故障恢复”。或者，如果原始虚拟机表现出意外行为，请选择“撤消故障回复”以恢复到虚拟机副本。

* *撤消故障转移* - 恢复到原始 VM，丢弃在运行期间对 VM 副本所做的所有更改。
* *永久故障转移* - 从原始虚拟机永久切换到其副本，并将副本建立为正在进行的操作的新主虚拟机。


在这种情况下，选择了“故障恢复到生产”选项。

完成以下步骤以故障恢复到生产站点：

. 从*主页*视图中，单击左侧菜单中的*副本>活动*。选择要包含的虚拟机，然后单击顶部菜单中的“故障恢复到生产”按钮。
+
image::dr-veeam-gcnv-022.png[启动故障回复]

+
{nbsp}

. 在“故障回复”向导的“副本”页面上，选择要包含在故障回复作业中的副本。
. 在*目标*页面上，选择*故障恢复到原始虚拟机*，然后单击*下一步*继续。
+
image::dr-veeam-gcnv-023.png[故障恢复至原始虚拟机]

+
{nbsp}

. 在“故障恢复模式”页面上，选择“自动”以尽快启动故障恢复。
+
image::dr-veeam-gcnv-024.png[故障回复模式]

+
{nbsp}

. 在“摘要”页面上，选择是否“恢复后启动目标虚拟机”，然后单击“完成”以启动故障恢复作业。
+
image::dr-veeam-gcnv-025.png[故障回复作业摘要]

+
{nbsp}



故障回复提交完成故障回复操作，确认更改已成功集成到生产虚拟机。提交后，Veeam Backup & Replication 将恢复已恢复的生产虚拟机的常规复制活动。这会将恢复的副本的状态从_故障回复_更改为_就绪_。

. 要提交故障回复，请导航至 *Replicas > Active*，选择要提交的虚拟机，右键单击并选择 *Commit failback*。
+
image::dr-veeam-gcnv-026.png[提交故障回复]

+
{nbsp}

+
image::dr-veeam-gcnv-027.png[提交故障回复成功]

+
{nbsp} 故障恢复到生产环境成功后，所有虚拟机都将恢复到原始生产站点。



有关故障恢复过程的详细信息，请参阅 Veeam 文档link:https://helpcenter.veeam.com/docs/backup/vsphere/failover_failback.html?ver=120["复制的故障转移和故障恢复"]。

====


== 结束语

Google Cloud NetApp Volumes数据存储功能使 Veeam 和其他经过验证的第三方工具能够提供经济高效的灾难恢复 (DR) 解决方案。通过利用 Pilot Light 集群而不是用于 VM 副本的大型专用集群，组织可以显著降低开支。这种方法可以实现定制的 DR 策略，利用现有的内部备份解决方案进行基于云的灾难恢复，从而无需额外的内部数据中心。如果发生灾难，只需单击即可启动故障转移或配置为自动发生故障转移，从而确保业务连续性并将停机时间降至最低。

要了解有关此过程的更多信息，请随意观看详细的演示视频。

video::b2fb8597-c3fe-49e2-8a84-b1f10118db6d[panopto,width=Video walkthrough of the solution]