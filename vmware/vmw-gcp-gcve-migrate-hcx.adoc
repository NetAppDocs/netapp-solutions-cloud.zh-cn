---
sidebar: sidebar 
permalink: vmware/vmw-gcp-gcve-migrate-hcx.html 
keywords: gcp, gcve, hybrid, multicloud, migrate, vmware, hcx, google, cloud, enterprise, hybrid, cloud, migration 
summary:  
---
= 使用 VMware HCX 将工作负载迁移到Google Cloud NetApp Volumes数据存储区 - 快速入门指南
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Google Cloud VMware Engine 和 Cloud Volume Service 数据存储最常见的用例之一是迁移 VMware 工作负载。  VMware HCX 是一个首选方案，它提供了各种迁移机制，可将本地虚拟机 (VM) 及其数据移动到 Cloud Volume Service NFS 数据存储。



== 概述：使用 VMware HCX、 Google Cloud NetApp Volumes数据存储区和 Google Cloud VMware Engine (GCVE) 迁移虚拟机

VMware HCX 主要是一个迁移平台，旨在简化应用程序迁移、工作负载重新平衡甚至跨云的业务连续性。它是 Google Cloud VMware Engine Private Cloud 的一部分，提供了多种迁移工作负载的方法，并可用于灾难恢复 (DR) 操作。

本文档提供了配置 Cloud Volume Service 数据存储区的分步指导，随后下载、部署和配置 VMware HCX，包括其在本地和 Google Cloud VMware Engine 端的所有主要组件（包括互连、网络扩展和 WAN 优化），以支持各种 VM 迁移机制。


NOTE: VMware HCX 适用于任何数据存储类型，因为迁移是在 VM 级别进行的。因此，本文档适用于现有NetApp客户和计划使用 Google Cloud VMware Engine 部署 Cloud Volume Service 以实现经济高效的 VMware 云部署的非NetApp客户。

.概要步骤
[%collapsible%open]
====
此列表提供了将虚拟机从本地 HCX Connector 配对并迁移到 Google Cloud VMware Engine 端的 HCX Cloud Manager 所需的高级步骤：

. 通过 Google VMware Engine 门户准备 HCX。
. 在本地 VMware vCenter Server 中下载并部署 HCX Connector Open Virtualization Appliance (OVA) 安装程序。
. 使用许可证密钥激活 HCX。
. 将本地 VMware HCX Connector 与 Google Cloud VMware Engine HCX Cloud Manager 配对。
. 配置网络配置文件、计算配置文件和服务网格。
. （可选）执行网络扩展以避免在迁移期间重新分配 IP。
. 验证设备状态并确保可以迁移。
. 迁移虚拟机工作负载。


====
.前提条件
[%collapsible%open]
====
开始之前，请确保满足以下先决条件。有关详细信息，请参阅 https://cloud.google.com/vmware-engine/docs/workloads/howto-migrate-vms-using-hcx["链接"^]。满足连接等先决条件后，从 Google Cloud VMware Engine 门户下载 HCX 许可证密钥。下载 OVA 安装程序后，按照如下所述进行安装过程。


NOTE: HCX 高级版是默认选项，VMware HCX 企业版也可通过支持票获得，并且无需额外付费即可获得支持。参考 https://cloud.google.com/blog/products/compute/whats-new-with-google-cloud-vmware-engine["此链接"^]

* 使用现有的 Google Cloud VMware Engine 软件定义数据中心 (SDDC) 或使用此link:vmw-gcp-gcve-setup.html["NetApp链接"^]或者这个 https://cloud.google.com/vmware-engine/docs/create-private-cloud["谷歌链接"^]。
* 从支持 VMware vSphere 的内部部署数据中心迁移虚拟机和相关数据需要从数据中心到 SDDC 环境的网络连接。在迁移工作负载之前， https://cloud.google.com/vmware-engine/docs/networking/howto-connect-to-onpremises["设置 Cloud VPN 或 Cloud Interconnect 连接"^]在本地环境和相应的私有云之间。
* 从本地 VMware vCenter Server 环境到 Google Cloud VMware Engine 私有云的网络路径必须支持使用 vMotion 迁移虚拟机。
* 确保所需的 https://ports.esp.vmware.com/home/VMware-HCX["防火墙规则和端口"^]允许在本地 vCenter Server 和 SDDC vCenter 之间进行 vMotion 流量。
* Cloud Volume Service NFS 卷应作为数据存储安装在 Google Cloud VMware Engine 中。按照本文中详细说明的步骤操作 https://cloud.google.com/vmware-engine/docs/vmware-ecosystem/howto-cloud-volumes-service-datastores["链接"^]将 Cloud Volume Service 数据存储附加到 Google Cloud VMware Engines 主机。


====
.高级架构
[%collapsible%open]
====
为了测试目的，用于此验证的本地实验室环境通过 Cloud VPN 连接，这允许本地连接到 Google Cloud VPC。

image:gcpd-hcx-001.png["该图描绘了该解决方案中使用的高级架构。"]

有关将 VMware HCX 与 Google 结合使用的更多详细信息，请参阅 https://cloud.google.com/vmware-engine/docs/workloads/howto-migrate-vms-using-hcx["VMware 链接"^]

====


== 解决方案部署

按照一系列步骤完成此解决方案的部署：

.步骤 1：通过 Google VMware Engine 门户准备 HCX
[%collapsible%open]
====
当您使用 VMware Engine 配置私有云时，HCX Cloud Manager 组件会自动安装。要准备站点配对，请完成以下步骤：

. 登录 Google VMware Engine 门户并登录 HCX Cloud Manager。
+
您可以通过单击 HCX 版本链接登录 HCX 控制台image:gcpd-hcx-002.png["通过 GCVE 资源上的链接访问 HCX 控制台"]或单击 vSphere 管理网络选项卡下的 HCX FQDN。image:gcpd-hcx-003.png["使用 FQDN 链接访问 HCX 控制台"]

. 在 HCX 云管理器中，转到“管理”>“系统更新”。
. 单击*请求下载链接*并下载 OVA 文件。image:gcpd-hcx-004.png["请求下载链接"]
. 将 HCX Cloud Manager 更新至 HCX Cloud Manager UI 提供的最新版本。


====
.步骤 2：在本地 vCenter Server 中部署安装程序 OVA
[%collapsible%open]
====
要使本地连接器连接到 Google Cloud VMware Engine 中的 HCX 管理器，请确保在本地环境中打开了相应的防火墙端口。

要在本地 vCenter Server 中下载并安装 HCX Connector，请完成以下步骤：

. 按照上一步所述，从 Google Cloud VMware Engine 上的 HCX 控制台下载 ova。
. 下载 OVA 后，使用 *部署 OVF 模板* 选项将其部署到本地 VMware vSphere 环境。
+
image:gcpd-hcx-005.png["屏幕截图以选择正确的 OVA 模板。"]

. 输入 OVA 部署所需的所有信息，单击“下一步”，然后单击“完成”以部署 VMware HCX 连接器 OVA。
+

NOTE: 手动启动虚拟设备。



有关分步说明，请参阅 https://cloud.google.com/vmware-engine/docs/workloads/howto-migrate-vms-using-hcx#prepare-for-hcx-manager-installation["Google HCX 文档"^]。

====
.步骤 3：使用许可证密钥激活 HCX Connector
[%collapsible%open]
====
在本地部署 VMware HCX Connector OVA 并启动设备后，完成以下步骤以激活 HCX Connector。从 Google Cloud VMware Engine 门户生成许可证密钥并在 VMware HCX Manager 中激活它。

. 在 VMware Engine 门户中，单击“资源”，选择私有云，然后*单击“HCX Manager 云版本”下的下载图标*。image:gcpd-hcx-006.png["下载 HCX 许可证"]打开下载的文件并复制许可证密钥字符串。
. 登录本地 VMware HCX 管理器 `"https://hcxmanagerIP:9443"`使用管理员凭据。
+

NOTE: 使用 OVA 部署期间定义的 hcxmanagerIP 和密码。

. 在许可中，输入从步骤 3 复制的密钥，然后单击 *激活*。
+

NOTE: 本地 HCX 连接器应该具有互联网访问权限。

. 在“数据中心位置”下，提供在本地安装 VMware HCX 管理器的最近位置。单击“继续”。
. 在“*系统名称*”下，更新名称并单击“*继续*”。
. 单击“是，继续”。
. 在“连接您的 vCenter”下，提供 vCenter Server 的完全限定域名 (FQDN) 或 IP 地址以及相应的凭据，然后单击“继续”。
+

NOTE: 使用 FQDN 以避免以后出现连接问题。

. 在“配置 SSO/PSC”下，提供平台服务控制器 (PSC) 的 FQDN 或 IP 地址，然后单击“继续”。
+

NOTE: 对于嵌入式 PSC，输入 VMware vCenter Server FQDN 或 IP 地址。

. 验证输入的信息是否正确，然后单击“*重新启动*”。
. 服务重新启动后，vCenter Server 在出现的页面上显示为绿色。  vCenter Server 和 SSO 都必须具有适当的配置参数，这些参数应与上一页相同。
+

NOTE: 此过程大约需要 10 到 20 分钟，以便将插件添加到 vCenter Server。

+
image:gcpd-hcx-007.png["屏幕截图显示了已完成的过程。"]



====
.步骤 4：将本地 VMware HCX 连接器与 Google Cloud VMware Engine HCX Cloud Manager 配对
[%collapsible%open]
====
在本地 vCenter 上部署和配置 HCX Connector 后，通过添加配对建立与 Cloud Manager 的连接。要配置站点配对，请完成以下步骤：

. 要在本地 vCenter 环境和 Google Cloud VMware Engine SDDC 之间创建站点对，请登录本地 vCenter Server 并访问新的 HCX vSphere Web Client 插件。
+
image:gcpd-hcx-008.png["HCX vSphere Web Client 插件的屏幕截图。"]

. 在基础设施下，单击*添加站点配对*。
+

NOTE: 输入 Google Cloud VMware Engine HCX Cloud Manager URL 或 IP 地址以及具有 Cloud-Owner-Role 权限的用户访问私有云的凭据。

+
image:gcpd-hcx-009.png["屏幕截图 CloudOwner 角色的 URL 或 IP 地址和凭据。"]

. 单击“连接”。
+

NOTE: VMware HCX Connector 必须能够通过端口 443 路由到 HCX Cloud Manager IP。

. 创建配对后，新配置的站点配对可在 HCX 仪表板上获得。
+
image:gcpd-hcx-010.png["HCX 仪表板上已完成流程的屏幕截图。"]



====
.步骤 5：配置网络配置文件、计算配置文件和服务网格
[%collapsible%open]
====
VMware HCX Interconnect 服务设备通过互联网和与目标站点的专用连接提供复制和基于 vMotion 的迁移功能。互连提供加密、流量工程和 VM 移动性。要创建互连服务设备，请完成以下步骤：

. 在基础设施下，选择*互连>多站点服务网格>计算配置文件>创建计算配置文件*。
+

NOTE: 计算配置文件定义部署参数，包括部署的设备以及 VMware 数据中心的哪些部分可供 HCX 服务访问。

+
image:gcpd-hcx-011.png["vSphere 客户端互连页面的屏幕截图。"]

. 创建计算配置文件后，通过选择“多站点服务网格”>“网络配置文件”>“创建网络配置文件”来创建网络配置文件。
+
网络配置文件定义了 HCX 用于其虚拟设备的一系列 IP 地址和网络。

+

NOTE: 此步骤需要两个或更多 IP 地址。这些 IP 地址由管理网络分配给互连设备。

+
image:gcpd-hcx-012.png["网络概况的屏幕截图。"]

. 此时，计算和网络配置文件已成功创建。
. 通过选择“*Interconnect*”选项中的“*Service Mesh*”选项卡来创建服务网格，并选择本地和 GCVE SDDC 站点。
. 服务网格指定本地和远程计算和网络配置文件对。
+

NOTE: 作为此过程的一部分，HCX 设备在源站点和目标站点上部署并自动配置，以创建安全的传输结构。

+
image:gcpd-hcx-013.png["vSphere 客户端互连页面上的服务网格选项卡的屏幕截图。"]

. 这是配置的最后一步。完成部署大约需要 30 分钟。配置服务网格后，环境已准备就绪，并且已成功创建 IPsec 隧道来迁移工作负载虚拟机。
+
image:gcpd-hcx-014.png["vSphere 客户端互连页面上的 HCX 设备的屏幕截图。"]



====
.步骤 6：迁移工作负载
[%collapsible%open]
====
可以使用各种 VMware HCX 迁移技术在本地和 GCVE SDDC 之间双向迁移工作负载。可以使用多种迁移技术将虚拟机移至 VMware HCX 激活的实体或从中移出，例如 HCX 批量迁移、HCX vMotion、HCX 冷迁移、HCX 复制辅助 vMotion（HCX 企业版提供）和 HCX OS 辅助迁移（HCX 企业版提供）。

要了解有关各种 HCX 迁移机制的更多信息，请参阅 https://cloud.google.com/vmware-engine/docs/workloads/howto-migrate-vms-using-hcx["使用 VMware HCX 文档迁移 VMware VM"^]。

HCX-IX 设备使用移动代理服务执行 vMotion、Cold 和复制辅助 vMotion (RAV) 迁移。


NOTE: HCX-IX 设备将移动代理服务添加为 vCenter Server 中的主机对象。此对象上显示的处理器、内存、存储和网络资源并不代表托管 IX 设备的物理虚拟机管理程序上的实际消耗。

*HCX vMotion*

本节介绍 HCX vMotion 机制。该迁移技术使用 VMware vMotion 协议将虚拟机迁移到 GCVE。 vMotion 迁移选项用于一次迁移单个 VM 的 VM 状态。此迁移方法期间不会中断服务。


NOTE: 应该实施网络扩展（针对虚拟机所连接的端口组），以便迁移虚拟机而无需更改 IP 地址。

. 从本地 vSphere 客户端，转到“清单”，右键单击要迁移的虚拟机，然后选择“HCX 操作”>“迁移到 HCX 目标站点”。
+
image:gcpd-hcx-015.png["该图显示输入/输出对话框或表示书面内容"]

. 在迁移虚拟机向导中，选择远程站点连接（目标 GCVE）。
+
image:gcpd-hcx-016.png["该图显示输入/输出对话框或表示书面内容"]

. 更新必填字段（集群、存储和目标网络），单击验证。
+
image:gcpd-hcx-017.png["该图显示输入/输出对话框或表示书面内容"]

. 验证检查完成后，单击“Go”开始迁移。
+

NOTE: vMotion 传输捕获 VM 活动内存、其执行状态、其 IP 地址和其 MAC 地址。有关 HCX vMotion 的要求和限制的更多信息，请参阅 https://techdocs.broadcom.com/us/en/vmware-cis/hcx/vmware-hcx/4-10/vmware-hcx-user-guide-4-10/migrating-virtual-machines-with-vmware-hcx/understanding-vmware-hcx-vmotion-and-cold-migration.html#GUID-517866F6-AF06-4EFC-8FAE-DA067418D584-en["了解 VMware HCX vMotion 和冷迁移"^]。

. 您可以从 HCX > 迁移仪表板监控 vMotion 的进度和完成情况。
+
image:gcpd-hcx-018.png["该图显示输入/输出对话框或表示书面内容"]




NOTE: 目标Google Cloud NetApp Volumes （NetApp Volumes）NFS 数据存储应具有足够的空间来处理迁移。

====


== 结束语

无论您的目标是全云还是混合云，以及驻留在本地任何类型/供应商存储上的数据，Cloud Volume Service 和 HCX 都提供了部署和迁移应用程序工作负载的绝佳选择，同时通过使数据需求无缝连接到应用程序层来降低 TCO。无论用例如何，选择 Google Cloud VMware Engine 以及 Cloud Volume Service 都可以快速实现云优势、跨本地和多云的一致基础架构和操作、工作负载的双向可移植性以及企业级容量和性能。使用 VMware vSphere Replication、VMware vMotion 甚至网络文件复制 (NFC) 连接存储和迁移虚拟机所使用的过程和程序相同。



== 总结

该文件的要点包括：

* 您现在可以将 Cloud Volume Service 用作 Google Cloud VMware Engine SDDC 上的数据存储。
* 您可以轻松地将数据从本地迁移到 Cloud Volume Service 数据存储。
* 您可以轻松扩大或缩小 Cloud Volume Service 数据存储以满足迁移活动期间的容量和性能要求。




== 参考 Google 和 VMware 的视频

.来自谷歌
[%collapsible%open]
====
* link:https://www.youtube.com/watch?v=xZOtqiHY5Uw["使用 GCVE 部署 HCX 连接器"]
* link:https://youtu.be/2ObPvekMlqA["使用 GCVE 配置 HCX ServiceMesh"]
* link:https://youtu.be/zQSGq4STX1s["将带有 HCX 的虚拟机迁移到 GCVE"]


====
.来自 VMware
[%collapsible%open]
====
* link:https://youtu.be/EFE5ZYFit3M["适用于 GCVE 的 HCX 连接器部署"]
* link:https://youtu.be/uwRFFqbezIE["GCVE 的 HCX ServiceMesh 配置"]
* link:https://youtu.be/4KqL0Rxa3kM["HCX 工作负载迁移至 GCVE"]


====


== 在哪里可以找到更多信息

要了解有关本文档中描述的信息的更多信息，请参阅以下网站链接：

* Google Cloud VMware Engine 文档
+
https://cloud.google.com/vmware-engine/docs/overview/["https://cloud.google.com/vmware-engine/docs/overview"^]

* Cloud Volume Service 文档
+
https://cloud.google.com/architecture/partners/netapp-cloud-volumes["https://cloud.google.com/architecture/partners/netapp-cloud-volumes"^]

* VMware HCX 用户指南
+
https://docs.vmware.com/en/VMware-HCX/index.html["https://docs.vmware.com/en/VMware-HCX/index.html"^]


