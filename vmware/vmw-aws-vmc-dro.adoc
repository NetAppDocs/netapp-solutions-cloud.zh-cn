---
sidebar: sidebar 
permalink: vmware/vmw-aws-vmc-dro.html 
keywords: NetApp Solutions, hybrid, multicloud, multi cloud, hyperscalers, vmware, disaster recovery orchestrator, DRO 
summary:  
---
= TR-4955：使用 FSx ONTAP和 VMC 进行灾难恢复 (AWS VMware Cloud)
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
灾难恢复编排器（DRO；带有 UI 的脚本解决方案）可用于无缝恢复从本地复制到 FSx ONTAP 的工作负载。  DRO 可自动执行从SnapMirror级别到 VM 注册到 VMC 再到直接在 NSX-T 上进行网络映射的恢复。所有 VMC 环境均包含此功能。

NetApp的 Niyaz Mohamed



== 概述

灾难恢复到云端是一种具有弹性且经济高效的方法，可以保护工作负载免受站点中断和数据损坏事件（例如勒索软件）的影响。借助NetApp SnapMirror技术，本地 VMware 工作负载可以复制到在 AWS 中运行的 FSx ONTAP 。

灾难恢复编排器（DRO；带有 UI 的脚本解决方案）可用于无缝恢复从本地复制到 FSx ONTAP 的工作负载。  DRO 可自动执行从SnapMirror级别到 VM 注册到 VMC 再到直接在 NSX-T 上进行网络映射的恢复。所有 VMC 环境均包含此功能。

image:dro-vmc-001.png["此图描述了本地数据中心、VMware Cloud on AWS SDDC 实例和Amazon FSx ONTAP之间的结构和互连。这包括SnapMirror复制、DRaaS Ops 流量、互联网或直接连接以及 VMware Transit Connect。"]



== 入门



=== 在 AWS 上部署和配置 VMware Cloud

link:https://www.vmware.com/products/vmc-on-aws.html["AWS 上的 VMware Cloud"^]为 AWS 生态系统中基于 VMware 的工作负载提供云原生体验。每个 VMware 软件定义数据中心 (SDDC) 都在 Amazon 虚拟私有云 (VPC) 中运行，并提供完整的 VMware 堆栈（包括 vCenter Server）、NSX-T 软件定义网络、vSAN 软件定义存储以及一个或多个为工作负载提供计算和存储资源的 ESXi 主机。要在 AWS 上配置 VMC 环境，请按照以下步骤操作link:vmw-aws-vmc-setup.html["链接"^]。指示灯组也可用于 DR 目的。


NOTE: 在初始版本中，DRO 支持现有的指示灯集群。按需 SDDC 创建功能将在即将发布的版本中提供。



=== 配置 FSx ONTAP

Amazon FSx ONTAP是一项完全托管的服务，它基于流行的NetApp ONTAP文件系统构建，提供高度可靠、可扩展、高性能且功能丰富的文件存储。按照此处的步骤操作link:vmw-aws-vmc-nfs-ds-overview.html["链接"^]配置和配置 FSx ONTAP。



=== 部署并配置SnapMirror到 FSx ONTAP

下一步是使用NetApp BlueXP并发现 AWS 实例上配置的 FSx ONTAP ，并以适当的频率和NetApp Snapshot 副本保留将所需的数据存储卷从本地环境复制到 FSx ONTAP ：

image:dro-vmc-002.png["该图描绘了BlueXP Canvas 关系图，显示了启用的服务之间的各种交互。"]

按照此链接中的步骤配置BlueXP。您还可以使用NetApp ONTAP CLI 通过此链接安排复制。


NOTE: SnapMirror关系是先决条件，必须事先创建。



== DRO安装

要开始使用 DRO，请在指定的 EC2 实例或虚拟机上使用 Ubuntu 操作系统，以确保您满足先决条件。然后安装该包。



=== 前提条件

* 确保与源和目标 vCenter 和存储系统的连接存在。
* 如果您使用 DNS 名称，则应该进行 DNS 解析。否则，您应该使用 vCenter 和存储系统的 IP 地址。
* 创建具有root权限的用户。您还可以将 sudo 与 EC2 实例一起使用。




=== OS 要求

* Ubuntu 20.04 (LTS)，最低配置 2GB 内存和 4 个 vCPU
* 必须在指定的代理虚拟机上安装以下软件包：
+
** Docker
** Docker-compose
** 杰




更改权限 `docker.sock`： `sudo chmod 666 /var/run/docker.sock` 。


NOTE: 这 `deploy.sh`脚本执行所有必需的先决条件。



=== 安装包

. 在指定虚拟机上下载安装包：
+
[listing]
----
git clone https://github.com/NetApp/DRO-AWS.git
----
+

NOTE: 该代理可以安装在本地或 AWS VPC 内。

. 解压包，运行部署脚本，输入主机IP（例如10.10.10.10）。
+
[listing]
----
tar xvf DRO-prereq.tar
----
. 导航到目录并运行部署脚本，如下所示：
+
[listing]
----
sudo sh deploy.sh
----
. 使用以下方式访问 UI：
+
[listing]
----
https://<host-ip-address>
----
+
使用以下默认凭据：

+
[listing]
----
Username: admin
Password: admin
----



NOTE: 可以使用“更改密码”选项来更改密码。

image:dro-vmc-003.png["灾难恢复协调器登录屏幕。"]



== DRO 配置

正确配置 FSx ONTAP和 VMC 后，您可以开始配置 DRO，以使用 FSx ONTAP上的只读SnapMirror副本自动将本地工作负载恢复到 VMC。

NetApp建议在 AWS 中部署 DRO 代理，并将其部署到部署 FSx ONTAP 的同一 VPC（也可以对等连接），以便 DRO 代理可以通过网络与您的内部组件以及 FSx ONTAP和 VMC 资源进行通信。

第一步是发现并将本地和云资源（vCenter 和存储）添加到 DRO。在支持的浏览器中打开 DRO 并使用默认用户名和密码（admin/admin）并添加站点。还可以使用“发现”选项添加站点。添加以下平台：

* 本地
+
** 本地 vCenter
** ONTAP存储系统


* 云
+
** VMC vCenter
** FSx ONTAP




image:dro-vmc-004.png["临时占位符图像描述。"]

image:dro-vmc-005.png["DRO 站点概览页面包含源站点和目标站点。"]

添加后，DRO 会执行自动发现并显示从源存储到 FSx ONTAP具有相应SnapMirror副本的虚拟机。  DRO 自动检测虚拟机使用的网络和端口组并填充它们。

image:dro-vmc-006.png["自动发现屏幕包含 219 个虚拟机和 10 个数据存储区。"]

下一步是将所需的虚拟机分组到功能组中，作为资源组。



=== 资源分组

添加平台后，您可以将要恢复的虚拟机分组到资源组中。  DRO 资源组允许您将一组从属虚拟机分组为逻辑组，这些逻辑组包含它们的启动顺序、启动延迟以及可在恢复时执行的可选应用程序验证。

要开始创建资源组，请完成以下步骤：

. 访问*资源组*，然后单击*创建新资源组*。
. 在“*新资源组*”下，从下拉菜单中选择源站点，然后单击“*创建*”。
. 提供*资源组详细信息*并单击*继续*。
. 使用搜索选项选择适当的虚拟机。
. 为所选虚拟机选择启动顺序和启动延迟（秒）。通过选择每个虚拟机并设置其优先级来设置开机顺序。所有虚拟机的默认值都是三。
+
选项如下：

+
1 – 第一个启动的虚拟机 3 – 默认 5 – 最后一个启动的虚拟机

. 单击“创建资源组”。


image:dro-vmc-007.png["包含两个条目的资源组列表的屏幕截图：Test 和 DemoRG1。"]



=== 复制计划

您需要一个在发生灾难时恢复应用程序的计划。从下拉菜单中选择源和目标 vCenter 平台，并选择要包含在该计划中的资源组，以及应用程序应如何恢复和启动的分组（例如，域控制器，然后是第 1 层，然后是第 2 层，等等）。此类计划有时也称为蓝图。要定义恢复计划，请导航到“*复制计划*”选项卡并单击“*新建复制计划*”。

要开始创建复制计划，请完成以下步骤：

. 访问*复制计划*，然后单击*创建新的复制计划*。
+
image:dro-vmc-008.png["包含一个名为 DemoRP 的计划的复制计划屏幕的屏幕截图。"]

. 在“*新复制计划*”下，提供计划名称并通过选择源站点、关联 vCenter、目标站点和关联 vCenter 添加恢复映射。
+
image:dro-vmc-009.png["复制计划详细信息的屏幕截图，包括恢复映射。"]

. Recovery映射完成后，选择集群映射。
+
image:dro-vmc-010.png["临时占位符图像描述。"]

. 选择*资源组详情*并点击*继续*。
. 设置资源组的执行顺序。当存在多个资源组时，此选项可让您选择操作顺序。
. 完成后，选择网络映射到适当的网段。这些段应该已经在 VMC 中配置，因此请选择适当的段来映射 VM。
. 根据虚拟机的选择，自动选择数据存储映射。
+

NOTE: SnapMirror处于卷级别。因此，所有虚拟机都被复制到复制目标。确保选择数据存储区中的所有虚拟机。如果未选择，则仅处理复制计划中的虚拟机。

+
image:dro-vmc-011.png["临时占位符图像描述。"]

. 在 VM 详细信息下，您可以选择调整 VM 的 CPU 和 RAM 参数的大小；当将大型环境恢复到较小的目标集群或进行 DR 测试时，这非常有用，而无需配置一对一的物理 VMware 基础架构。此外，您还可以修改资源组中所有选定虚拟机的启动顺序和启动延迟（秒）。如果需要对资源组启动顺序选择期间选择的顺序进行任何更改，则可以选择修改启动顺序。默认情况下，使用在资源组选择期间选择的启动顺序；但是，可以在此阶段执行任何修改。
+
image:dro-vmc-012.png["临时占位符图像描述。"]

. 单击“创建复制计划”。
+
image:dro-vmc-013.png["临时占位符图像描述。"]



创建复制计划后，可以根据需求执行故障转移选项、测试故障转移选项或迁移选项。在故障转移和测试故障转移选项期间，使用最新的SnapMirror Snapshot 副本，或者可以从时间点 Snapshot 副本中选择特定的 Snapshot 副本（根据SnapMirror的保留策略）。如果您面临勒索软件之类的损坏事件，则时间点选项可能非常有用，其中最新的副本已被破坏或加密。 DRO 显示所有可用的时间点。要使用复制计划中指定的配置触发故障转移或测试故障转移，您可以单击“故障转移”或“测试故障转移”。

image:dro-vmc-014.png["临时占位符图像描述。"] image:dro-vmc-015.png["在此屏幕中，您将获得卷快照详细信息，并可以选择使用最新快照或选择特定快照。"]

可以在任务菜单中监控复制计划：

image:dro-vmc-016.png["任务菜单显示复制计划的所有作业和选项，还允许您查看日志。"]

触发故障转移后，可以在 VMC vCenter（虚拟机、网络、数据存储）中看到恢复的项目。默认情况下，虚拟机将恢复到工作负载文件夹。

image:dro-vmc-017.png["临时占位符图像描述。"]

可以在复制计划级别触发故障恢复。对于测试故障转移，可使用拆除选项来回滚更改并删除FlexClone关系。与故障转移相关的故障回复是一个两步过程。选择复制计划并选择*反向数据同步*。

image:dro-vmc-018.png["复制计划概述的屏幕截图，下拉菜单包含反向数据同步选项。"] image:dro-vmc-019.png["临时占位符图像描述。"]

一旦完成后，您可以触发故障恢复以返回到原始生产站点。

image:dro-vmc-020.png["复制计划概述的屏幕截图，下拉菜单包含故障回复选项。"] image:dro-vmc-021.png["DRO 摘要页面的屏幕截图，其中原始生产站点已启动并运行。"]

从NetApp BlueXP中，我们可以看到相应卷（作为读写卷映射到 VMC 的卷）的复制健康状况已中断。在测试故障转移期间，DRO 不会映射目标卷或副本卷。相反，它会创建所需SnapMirror （或 Snapshot）实例的FlexClone副本并公开该FlexClone实例，这样就不会消耗 FSx ONTAP的额外物理容量。此过程可确保卷不会被修改，并且即使在 DR 测试或分类工作流程期间，复制作业也可以继续。此外，此过程可确保如果发生错误或恢复损坏的数据，则可以清理恢复，而不会有副本被破坏的风险。

image:dro-vmc-022.png["临时占位符图像描述。"]



=== 勒索软件恢复

从勒索软件中恢复可能是一项艰巨的任务。具体来说，IT 组织很难确定安全的返回点，而且一旦确定，就很难保护恢复的工作负载免受休眠恶意软件或易受攻击的应用程序等的重复攻击。

DRO 可让您从任何可用时间点恢复系统，从而解决这些问题。您还可以将工作负载恢复到功能正常但隔离的网络中，以便应用程序可以在不会暴露于南北流量的位置运行并相互通信。这为您的安全团队提供了一个安全的地方来进行取证，并确保没有隐藏或休眠的恶意软件。



== 受益

* 使用高效且有弹性的SnapMirror复制。
* 通过 Snapshot 副本保留恢复到任何可用的时间点。
* 完全自动化从存储、计算、网络和应用程序验证步骤中恢复数百到数千台虚拟机所需的所有步骤。
* 使用ONTAP FlexClone技术进行工作负载恢复，采用的方法是不改变复制卷。
+
** 避免卷或 Snapshot 副本的数据损坏风险。
** 避免 DR 测试工作流程期间的复制中断。
** DR 数据与云计算资源的潜在用途，可用于 DR 以外的工作流程，例如开发测试、安全测试、补丁或升级测试以及补救测试。


* 通过允许恢复到较小的计算集群，CPU 和 RAM 优化有助于降低云成本。

